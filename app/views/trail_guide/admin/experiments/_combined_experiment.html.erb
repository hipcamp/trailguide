<div class="experiment row justify-content-center">
  <div class="col-sm-12 col-md-10 col-lg-8">
    <%= render partial: "header", locals: { experiment: combined_experiment } %>

    <table class="table table-hover">
      <% combined_experiments = combined_experiment.combined.map { |e| TrailGuide.catalog.find(e) } %>
      <% combined_experiments.each do |experiment| %>
        <thead class="thead-light">
          <tr>
            <th scope="col">
              <h5 id="<%= experiment.experiment_name %>">
                <%= link_to experiment.experiment_name.to_s.humanize.titleize, trail_guide_admin.experiments_path(anchor: experiment.experiment_name), class: "text-dark" %>
              </h5>
            </th>

            <th scope="col">Participants</th>

            <% if experiment.goals.empty? %>
              <th scope="col">Converted</th>
            <% else %>
              <% experiment.goals.each do |goal| %>
                <th scope="col"><%= goal.to_s.humanize.titleize %></th>
              <% end %>
            <% end %>

            <th>&nbsp;</th>
          </tr>
        </thead>

        <tbody>
          <% experiment.variants.each do |variant| %>
            <tr>
              <th scope="row">
                <% if experiment.configuration.preview_url? %>
                  <%= link_to variant.name.to_s.humanize.titleize, preview_url(variant), target: :blank, class: "text-dark" %>
                <% else %>
                  <%= variant.name.to_s.humanize.titleize %>
                <% end %>

                <% if experiment.running? && !experiment.winner? && participant.variant(experiment) == variant %>
                  <span class="fas fa-user text-muted" data-toggle="tooltip" title="you are currently in this cohort"></span>
                <% end %>
                <% if experiment.winner? && variant == experiment.winner %>
                  <span class="fas fa-star text-primary" data-toggle="tooltip" title="this variant has been promoted as the winner of the experiment"></span>
                <% end %>
                <% if variant.control? %>
                  <span class="fas fa-cog text-muted" data-toggle="tooltip" title="this variant is the control group for this experiment"></span>
                <% end %>
              </th>

              <td><%= experiment_metric combined_experiment, variant.participants %></td>

              <% if experiment.goals.empty? %>
                <td><%= experiment_metric combined_experiment, variant.converted %></td>
              <% else %>
                <% experiment.goals.each do |goal| %>
                  <td><%= experiment_metric combined_experiment, variant.converted(goal) %></td>
                <% end %>
              <% end %>

              <td class="text-right">
                <% if experiment.running? && !experiment.winner? %>
                  <% if participant.variant(experiment) == variant %>
                    <%= link_to trail_guide_admin.leave_experiment_path(experiment.experiment_name), class: "btn btn-sm btn-outline-secondary", method: :put, data: {toggle: :tooltip}, title: 'leave this cohort' do %>
                      <span class="fas fa-sign-out-alt" />
                    <% end %>
                  <% else %>
                    <%= link_to trail_guide_admin.join_experiment_path(experiment.experiment_name, variant.name), class: "btn btn-sm btn-secondary", method: :put, data: {toggle: :tooltip}, title: 'join this cohort' do %>
                      <span class="fas fa-sign-in-alt" />
                    <% end %>
                  <% end %>
                <% end %>

                <% if !experiment.winner? || variant != experiment.winner %>
                  <%= link_to trail_guide_admin.winner_experiment_path(experiment.experiment_name, variant.name), class: "btn btn-sm btn-#{experiment.winner? ? "outline-" : ""}primary", method: :put, data: {toggle: :tooltip}, title: 'rollout this variant as the winner for this experiment' do %>
                    <span class="fas fa-star" />
                  <% end %>
                <% elsif experiment.winner? && variant == experiment.winner %>
                  <%= link_to trail_guide_admin.clear_experiment_path(experiment.experiment_name), class: "btn btn-sm btn-warning", method: :put, data: {toggle: :tooltip}, title: 'remove this variant as the selected winner' do %>
                    <span class="fas fa-window-close" />
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      <% end %>

      <tfoot class="thead-light">
        <tr>
          <th scope="row">&nbsp;</th>
          <th>
            <span><%= number_with_delimiter combined_experiment.participants %></span>
            <% if combined_experiment.configuration.target_sample_size %>
              <span class="text-muted">/ <%= number_with_delimiter combined_experiment.configuration.target_sample_size %></span>
            <% end %>
          </th>
          <% if combined_experiment.goals.empty? %>
            <th><%= experiment_metric combined_experiment, combined_experiments.sum(&:converted) %></th>
          <% else %>
            <% combined_experiment.goals.each do |goal| %>
              <th><%= experiment_metric combined_experiment, combined_experiments.sum { |e| e.converted(goal) } %></th>
            <% end %>
          <% end %>
          <th>&nbsp;</th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
